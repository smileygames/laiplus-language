name: li-ci

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  gate:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - name: Require Issue reference (Li+ R1)
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const text = `${pr.title}\n${pr.body || ""}`;

            const ok =
              /#\d+/.test(text) ||
              /GH-\d+/i.test(text) ||
              /Issue:\s*\S+/i.test(text);

            if (!ok) {
              core.setFailed(
                "Li+ R1 violation: PR title or body must reference an Issue (e.g., #35)."
              );
            }

      - name: Generate CI summary (gate)
        if: always()
        run: |
          mkdir -p artifacts
          {
            echo "# CI Summary (gate)"
            echo ""
            echo "- Job: gate"
            echo "- Result: ${{ job.status }}"
            echo "- Workflow: ${{ github.workflow }}"
            echo "- Run ID: ${{ github.run_id }}"
            echo "- Commit: ${{ github.sha }}"
            echo "- Ref: ${{ github.ref }}"
            echo "- Event: ${{ github.event_name }}"
            echo ""
            echo "## Observation"
            echo "- This job checks Li+ R1 (Issue-driven changes)."
            echo "- Failure indicates missing or invalid Issue reference."
            echo ""
            echo "## Next"
            echo "- If failed: add an Issue reference (e.g., #35) to PR title or body."
            echo "- Evidence: workflow logs and uploaded artifacts."
          } > artifacts/ci_summary_gate.md

      - name: Upload artifacts (gate)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: li-ci-artifacts-gate
          path: artifacts/
          if-no-files-found: warn

  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Placeholder execution (Li+ minimal)
        run: |
          echo "Li+ CI: placeholder execution"
          exit 0

      - name: Generate CI summary (tests)
        if: always()
        run: |
          mkdir -p artifacts
          {
            echo "# CI Summary (tests)"
            echo ""
            echo "- Job: tests"
            echo "- Result: ${{ job.status }}"
            echo "- Workflow: ${{ github.workflow }}"
            echo "- Run ID: ${{ github.run_id }}"
            echo "- Commit: ${{ github.sha }}"
            echo "- Ref: ${{ github.ref }}"
            echo "- Event: ${{ github.event_name }}"
            echo ""
            echo "## Observation"
            echo "- This job represents execution evidence."
            echo "- Replace placeholder with real build/tests later."
            echo ""
            echo "## Next"
            echo "- Add real commands and put their outputs under artifacts/."
            echo "- CI is an evidence generator, not a quality gate."
          } > artifacts/ci_summary_tests.md

      - name: Upload artifacts (tests)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: li-ci-artifacts-tests
          path: artifacts/
          if-no-files-found: warn

      - name: Post CI summaries to PR comment
        if: ${{ github.event_name == 'pull_request' && always() }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          pr="${{ github.event.pull_request.number }}"
          body="$(cat artifacts/ci_summary_gate.md 2>/dev/null; echo; cat artifacts/ci_summary_tests.md 2>/dev/null)"
          gh api -X POST "repos/${{ github.repository }}/issues/$pr/comments" \
            -f body="$body"
